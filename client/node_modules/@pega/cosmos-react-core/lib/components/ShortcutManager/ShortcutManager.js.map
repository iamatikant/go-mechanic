{"version":3,"file":"ShortcutManager.js","sourceRoot":"","sources":["../../../src/components/ShortcutManager/ShortcutManager.tsx"],"names":[],"mappings":"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","sourcesContent":["import { FunctionComponent, useEffect, useRef, useMemo, Context, useContext } from 'react';\nimport { Shortcuts } from 'shortcuts';\n\nimport { useAfterInitialEffect } from '../../hooks';\nimport { windowIsAvailable } from '../../utils';\n\nimport { ShortcutManagerContext, type ShortcutManagerContextValue } from './Context';\nimport type {\n  ShortcutAction,\n  ShortcutActionConfig,\n  ShortcutManagerProps\n} from './ShortcutManager.types';\n\ndeclare module '../../init' {\n  export interface CosmosGlobals {\n    shortcutManagerContext?: Context<ShortcutManagerContextValue>;\n  }\n}\n\nconst actionRegistry = new Map<string, ShortcutActionConfig>();\n\n/**\n * Function to register an action triggerable using a shortcut. All actions must be registered before\n * binding a callback.\n * @param actions actions with definitions to be registered.\n */\nexport const registerAction = (...actions: ShortcutAction[]): void => {\n  actions.forEach(({ id, defaultKeyBinding: defaultShortcut }) => {\n    if (!actionRegistry.has(id)) {\n      actionRegistry.set(id, { defaultKeyBinding: defaultShortcut });\n    }\n  });\n};\n\nconst dispatchShortcutEvent = (actionId: ShortcutAction['id'], e: KeyboardEvent) => {\n  const shortcutEvent = new CustomEvent('shortcut', {\n    bubbles: true,\n    detail: { actionId }\n  });\n  e.target?.dispatchEvent(shortcutEvent);\n};\n\nconst ShortcutManager: FunctionComponent<ShortcutManagerProps> = ({\n  children,\n  target,\n  bindings: customBindings = {}\n}) => {\n  const shortcutsRef = useRef<Shortcuts>();\n\n  const bindings = Object.fromEntries(\n    Array.from(actionRegistry.entries()).map(([action, actionDef]) => [\n      action,\n      customBindings[action] ?? actionDef.defaultKeyBinding\n    ])\n  );\n\n  const context = windowIsAvailable\n    ? window.cosmos.shortcutManagerContext ?? ShortcutManagerContext\n    : ShortcutManagerContext;\n  const priorCtxValue = useContext(context);\n\n  useEffect(() => {\n    // bail out if ShortcutManager has been initialized\n    if (priorCtxValue.initialized) return;\n\n    shortcutsRef.current = new Shortcuts({\n      target,\n      shouldHandleEvent: e =>\n        // both 'keydown' and 'keypress' events are handled by default ('shortcuts' bug?)\n        e.type === 'keydown' &&\n        !e.defaultPrevented &&\n        // don't process event during typing letters/digits into inputs without modifier keys\n        !(\n          e.target instanceof HTMLElement &&\n          ['input', 'textarea'].includes(e.target.nodeName.toLowerCase()) &&\n          e.key.match(/a-zA-Z0-9/) &&\n          !['Control', 'Meta'].some(modifier => e.getModifierState(modifier))\n        ),\n      shortcuts: Object.entries(bindings).map(([action, shortcut]) => ({\n        shortcut,\n        handler: e => {\n          e.preventDefault();\n          dispatchShortcutEvent(action, e);\n        }\n      }))\n    });\n\n    return () => {\n      shortcutsRef.current?.reset();\n      shortcutsRef.current = undefined;\n    };\n  }, [target]);\n\n  useAfterInitialEffect(() => {\n    // bail out if ShortcutManager has been initialized\n    if (priorCtxValue.initialized) return;\n\n    const shortcutInstance = shortcutsRef.current;\n    if (shortcutInstance) {\n      shortcutInstance.reset();\n      shortcutInstance.add(\n        Object.entries(bindings).map(([action, shortcut]) => ({\n          shortcut,\n          handler: e => dispatchShortcutEvent(action, e)\n        }))\n      );\n    }\n  }, [JSON.stringify(bindings)]);\n\n  const ctxValue = useMemo(\n    () => ({\n      bindings: Object.freeze(bindings),\n      initialized: true\n    }),\n    [JSON.stringify(bindings)]\n  );\n\n  if (priorCtxValue.initialized) {\n    return <context.Provider value={priorCtxValue}>{children}</context.Provider>;\n  }\n\n  return (\n    <ShortcutManagerContext.Provider value={ctxValue}>{children}</ShortcutManagerContext.Provider>\n  );\n};\n\nexport default ShortcutManager;\n"]}